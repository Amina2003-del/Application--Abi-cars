<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org">
<head>
    <!-- Meta Tags -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Espace Propriétaire - Notifications</title>

    <!-- External CSS and Fonts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.5.0/css/flag-icon.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css" rel="stylesheet">
    <!-- Suppression des imports non utilisés sur CETTE page (Chart, PDF, FullCalendar, Bootstrap Table) -->

           <link rel="stylesheet" th:href="@{/assets/css/notificationowner.css}">

</head>
<body class="light-theme"> <!-- Forcer thème clair -->

    <!-- Barre de navigation (Style Tailwind) -->
      <nav class="navbar-custom-tailwind" th:fragment="navbar">
    <div class="navbar-left">
        <span class="brand">ABIcars</span>
    </div>
    <div class="navbar-right">
        <!-- Bouton menu hamburger pour responsive (visible seulement sur mobile) -->
        <div class="nav-icon-btn mobile-menu-toggle" id="mobileMenuToggle">
            <i class="fas fa-bars"></i>
        </div>
        
        <div class="nav-icon-btn" id="alertsIconCustom">
            <!-- Contenu des alertes si besoin -->
        </div>
        <div class="nav-icon-btn" id="languageSwitchCustom">
            <span class="flag-icon flag-icon-fr"></span>
        </div>
        <div class="user-profile" id="userProfileCustom"> <!-- Utilisation du style user-profile -->
            <i class="fas fa-user-circle"></i> <!-- Icône Font Awesome plus stylée -->
            <span th:text="${currentUser != null ? currentUser.firstName + ' ' + currentUser.lastName : 'Invité'}"></span>
            <i class="fas fa-chevron-down fa-xs"></i>
        </div>
        <div class="dropdown-menu-custom" id="userDropdownCustom">
            <a href="#" id="showUserProfile">
                <i class="fas fa-user-edit"></i>Mon profil
            </a>
        <a th:href="@{/Siteoffeciel/index}" >
  <i class="fas fa-sign-out-alt"></i>Se déconnecter
</a>
        </div>
    </div>
</nav>
<div class="modal fade" id="userModal" tabindex="-1" aria-labelledby="userModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      
      <div class="modal-header bg-primary text-white rounded-top">
        <h5 class="modal-title" id="userModalLabel">Profil Utilisateur</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body user-info">
        <form id="userProfileForm">
          <div class="row g-3">

            <div class="col-md-6">
              <label for="firstName" class="form-label">Prénom</label>
              <input type="text" class="form-control" id="firstName" name="firstName">
            </div>

            <div class="col-md-6">
              <label for="lastName" class="form-label">Nom</label>
              <input type="text" class="form-control" id="lastName" name="lastName">
            </div>

            <div class="col-md-6">
              <label for="phone" class="form-label">Téléphone</label>
              <input type="tel" class="form-control" id="phone" name="phone">
            </div>

            <div class="col-md-6">
              <label for="email" class="form-label">Email</label>
              <input type="email" class="form-control" id="email" name="email">
            </div>

            <div class="col-12 position-relative">
              <label for="password" class="form-label">Nouveau mot de passe</label>
              <input type="password" class="form-control pe-5" id="password" name="password">
                        <i class="fas fa-eye password-toggle" id="togglePassword"></i>
            </div>

          </div>
        </form>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
        <button type="button" class="btn btn-primary" id="saveProfile">Enregistrer</button>
      </div>

    </div>
  </div>
</div>

    <!-- Modal pour les alertes -->
   <div class="modal-custom-non-bootstrap" id="alertsModalCustom">
    <div class="modal-header-custom-non-bootstrap">
        <h3>Alertes récentes</h3>
        <span class="close-btn" id="closeAlertsModalCustom">×</span>
    </div>

    <div class="modal-body-custom-non-bootstrap">
        <div class="alert-item" th:each="alert : ${recentAlerts}">
            <div class="alert-content">
                <div class="alert-title" th:text="${alert.sujet != null ? alert.sujet : 'Sujet inconnu'}">Maintenance voiture</div>
                <div class="alert-message" th:text="${alert.message != null ? alert.message : 'Message non disponible'}">Vérification requise.</div>
            </div>
            <div class="alert-meta">
                <div class="alert-time" th:text="${alert.formattedDate}">01/01/2024 12:00</div>

                <span class="alert-status"
                      th:classappend="' ' + (alert.type == 'ALERTE' ? 'status-urgent' : (alert.type == 'NOTIFICATION' ? 'status-new' : 'status-waiting'))"
                      th:text="${alert.type != null ? alert.type : 'TYPE?'}">
                    TYPE
                </span>
            </div>
        </div>
    </div>
</div>

    <!-- Barre latérale (Style Tailwind) -->
    <aside id="sidebarCustom" class="sidebar-custom-tailwind sidebar-expanded">
        <div class="sidebar-header">
            <div class="brand-logo-wrapper">
                <i class="fas fa-car-alt brand-icon"></i>
                <span class="brand-text" id="sidebarBrandText">ABIcars</span>
            </div>
            <button id="toggleSidebarCustom" class="toggle-btn">
                <i class="fas fa-chevron-left"></i>
            </button>
        </div>
        <nav class="sidebar-menu">
            <a href="/Owner/dashbord" class="sidebar-item">
                <i class="fas fa-tachometer-alt menu-icon text-blue-400"></i>
                <span class="sidebar-text">Tableau de Bord</span>
            </a>
            <a href="/Owner/message" class="sidebar-item">
                <i class="fas fa-envelope menu-icon text-sky-400"></i>
                <span class="sidebar-text">Messages</span>
            </a>
            <a href="/Owner/clientespace" class="sidebar-item">
                <i class="fas fa-users menu-icon text-fuchsia-400"></i>
                <span class="sidebar-text">Clients</span>
            </a>
            <a href="/Owner/litige" class="sidebar-item">
                <i class="fas fa-gavel menu-icon text-rose-500"></i>
                <span class="sidebar-text">Litiges</span>
            </a>
            <a href="/Owner/voitures" class="sidebar-item">
                <i class="fas fa-car-side menu-icon text-emerald-500"></i>
                <span class="sidebar-text">Voitures</span>
            </a>
            <a href="/Owner/reservation" class="sidebar-item">
                <i class="fas fa-calendar-check menu-icon text-amber-500"></i>
                <span class="sidebar-text">Réservations</span>
            </a>
            <a href="/Owner/notifications" class="sidebar-item active"> <!-- Notifications est actif -->
                <i class="fas fa-bell menu-icon text-violet-500"></i>
                <span class="sidebar-text">Notifications</span>
            </a>
               <a href="/Owner/entretiens" class="sidebar-item">
    <i class="fas fa-wrench menu-icon text-orange-400"></i>
    <span class="sidebar-text">Entretiens</span>
</a>
            <a href="/Owner/paiement" class="sidebar-item">
                <i class="fas fa-credit-card menu-icon text-cyan-500"></i>
                <span class="sidebar-text">Paiement</span>
            </a>
        </nav>
    </aside>



    <!-- Contenu principal -->
    <div id="mainContent" class="main-content sidebar-expanded">
        <div class="container animate-fadeInUp">
            <h1 class="section-title">Espace Propriétaire - Notifications</h1>

            <div class="filter-bar">
                <button class="filter-btn active" onclick="filterNotifications('all')">Tous</button>
                <button class="filter-btn" onclick="filterNotifications('received')">Reçus</button>
                <button class="filter-btn" onclick="filterNotifications('pending')">En attente</button>
                <button class="filter-btn" onclick="filterNotifications('failed')">Échoués</button>
                <button class="btn btn-secondary" onclick="markAllAsRead()">Tout marquer comme lu</button>
            </div>

            <div id="notificationList" class="space-y-4"></div>

            <div class="pagination mt-4">
                <button id="prevPage" onclick="changePage(-1)" disabled>Précédent</button>
                <span id="pageIndicator">Page 1</span>
                <button id="nextPage" onclick="changePage(1)">Suivant</button>
            </div>

           

            <!-- Modal pour toutes les notifications -->
            <div class="modal fade modal-fullscreen-custom" id="notificationModalFull" tabindex="-1">
                <div class="modal-dialog modal-dialog-scrollable">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Toutes les Notifications</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div id="modalNotificationList" class="space-y-4"></div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-light" data-bs-dismiss="modal">Fermer</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    
    <script>
    let currentPage = 0;
    const size = 5;
    let currentFilter = 'all';

    // Récupérer les notifications avec AJAX (pagination + filtre)
    function fetchNotifications() {
        $.ajax({
            url: `/Owner/notification?page=${currentPage}&size=${size}&filter=${currentFilter}`,
            method: 'GET',
            success: function(data) {
                displayNotifications(data);
                updatePaginationControls(data);
            },
            error: function() {
                Toastify({
                    text: "Erreur lors du chargement des notifications",
                    duration: 3000,
                    backgroundColor: "var(--error-bg)"
                }).showToast();
            }
        });
    }

    // Afficher les notifications dans les containers
    function displayNotifications(data) {
        const list = $('#notificationList');
        const modalList = $('#modalNotificationList');
        list.empty();
        modalList.empty();

        if (!data || !Array.isArray(data.content) || data.content.length === 0) {
            list.html('<p>Aucune notification.</p>');
            modalList.html('<p>Aucune notification.</p>');
            return;
        }

        data.content.forEach(n => {
            const html = createNotificationCard(n);
            list.append(html);
            modalList.append(html);
        });
    }

    // Met à jour les boutons de pagination et indicateur
    function updatePaginationControls(data) {
        $('#pageIndicator').text(`Page ${currentPage + 1}`);
        $('#prevPage').prop('disabled', currentPage === 0);
        $('#nextPage').prop('disabled', data.last);
    }

    // Créer une carte de notification (HTML)
    function createNotificationCard(n) {
        // Déterminer le status CSS
        const status = n.type === 'ALERTE' ? 'failed' 
                      : n.type === 'NOTIFICATION' ? 'received' 
                      : 'pending';
        console.log('Type notification:', n.type);

        // Titre par défaut selon type ou sujet/message
        let titre = n.sujet || (n.type === 'RESERVATION' ? 'Réservation effectuée' :
                               n.type === 'LITIGE' ? 'Litige signalé' :
                               n.type === 'PAIEMENT' ? 'Paiement reçu' :
                               n.message ? n.message.split('.')[0] : 'Notification');

        // Formatage date
        let date;
        if (Array.isArray(n.dateEnvoi)) {
            // Exemple: [2025, 6, 4, 0, 19, 8]
            const d = n.dateEnvoi;
            const dateObj = new Date(d[0], d[1] - 1, d[2], d[3], d[4], d[5]);
            date = dateObj.toLocaleString('fr-FR');
        } else {
            // Si c’est une chaîne ou timestamp
            date = new Date(n.dateEnvoi).toLocaleString('fr-FR');
        }

        return `
            <div class="notification-card ${n.envoyeAvecSucces ? '' : 'unread'}" data-status="${status}">
                <div class="notification-content">
                    <div class="notification-details">
                        <h3>${titre}</h3>
                        <p>${n.message}</p>
                        <div class="time">${date}</div>
                    </div>
                    <span class="notification-status status-${status}">${status.charAt(0).toUpperCase() + status.slice(1)}</span>
                </div>
                <div class="notification-actions mt-2 text-end">
                    <button onclick="markAsRead(${n.id}, this)">Marquer comme lu</button>
                </div>
            </div>`;
    }

    // Changer de page (+1 ou -1)
    function changePage(offset) {
        currentPage += offset;
        if(currentPage < 0) currentPage = 0;
        fetchNotifications();
    }

    // Filtrer les notifications par type
    function filterNotifications(filter) {
        currentFilter = filter;
        currentPage = 0;
        $('.filter-btn').removeClass('active');
        $(`button[onclick="filterNotifications('${filter}')"]`).addClass('active');
        fetchNotifications();
    }

    // Marquer une notification comme lue
    function markAsRead(id, btn) {
        $.ajax({
            url: `/Owner/${id}/reads`,
            method: 'POST',
            success: function() {
                $(btn).closest('.notification-card').removeClass('unread');
                Toastify({
                    text: "Notification marquée comme lue",
                    duration: 2000,
                    backgroundColor: "var(--success-bg)"
                }).showToast();
            },
            error: function() {
                Toastify({
                    text: "Erreur lors de la mise à jour",
                    duration: 3000,
                    backgroundColor: "var(--error-bg)"
                }).showToast();
            }
        });
    }

    // Marquer toutes les notifications comme lues
    function markAllAsRead() {
        $.ajax({
            url: '/Owner/mark-all-read',
            method: 'POST',
            success: function() {
                $('.notification-card').removeClass('unread');
                Toastify({
                    text: "Toutes les notifications marquées comme lues",
                    duration: 2000,
                    backgroundColor: "var(--success-bg)"
                }).showToast();
            },
            error: function() {
                Toastify({
                    text: "Erreur lors de la mise à jour",
                    duration: 3000,
                    backgroundColor: "var(--error-bg)"
                }).showToast();
            }
        });
    }

    // Recherche locale dans notifications déjà chargées
    function searchNotifications() {
        const query = $('#navbarSearchInput').val().toLowerCase();
        $('.notification-card').each(function() {
            const title = $(this).find('h3').text().toLowerCase();
            const message = $(this).find('p').text().toLowerCase();
            $(this).toggle(title.includes(query) || message.includes(query));
        });
    }

    // Initialisation au chargement de la page
    $(document).ready(function() {
        fetchNotifications();

        // Toggle sidebar & modals
        $('#toggleSidebarCustom').click(() => {
            $('#sidebarCustom').toggleClass('sidebar-expanded sidebar-collapsed');
            $('#mainContent').toggleClass('sidebar-expanded sidebar-collapsed');
        });

        $('#mobileSidebarToggle').click(() => {
            $('#sidebarCustom').toggleClass('sidebar-show');
        });

        $('#alertsIconCustom').click(() => {
            $('#alertsModalCustom').toggleClass('active');
        });

        $('#closeAlertsModalCustom').click(() => {
            $('#alertsModalCustom').removeClass('active');
        });

        $('#userProfileCustom').click(() => {
            $('#userDropdownCustom').toggleClass('active');
        });

        // Event recherche (au keyup)
        $('#navbarSearchInput').on('keyup', searchNotifications);
    });
</script>
<script>
$(document).ready(function() {
    // Charger les données de l'utilisateur
    $('#showUserProfile').click(function(e) {
        e.preventDefault();
        $.ajax({
            url: '/api/user/profille',
            type: 'GET',
            success: function(user) {
                $('#firstName').val(user.firstName);
                $('#lastName').val(user.lastName);
                $('#phone').val(user.telephone);
                $('#email').val(user.email);
                $('#password').val(''); // Champ mot de passe vide par défaut
            },
            error: function(xhr) {
                alert('Erreur lors de la récupération des informations: ' + xhr.responseText);
            }
        });
    });

    // Basculer l'affichage du mot de passe
    $('#togglePassword').click(function() {
        const passwordField = $('#password');
        const type = passwordField.attr('type') === 'password' ? 'text' : 'password';
        passwordField.attr('type', type);
        $(this).toggleClass('fa-eye fa-eye-slash');
    });

    // Enregistrer les modifications
    $('#saveProfile').click(function() {
        const userData = {
            firstName: $('#firstName').val(),
            lastName: $('#lastName').val(),
            telephone: $('#phone').val(),
            email: $('#email').val(),
            password: $('#password').val()
        };

        $.ajax({
            url: '/api/user/proprofile',
            type: 'PUT',
            contentType: 'application/json',
            data: JSON.stringify(userData),
            success: function(response) {
                alert('Profil mis à jour avec succès !');
                $('#userModal').modal('hide');
            },
            error: function(xhr) {
                alert('Erreur lors de la mise à jour du profil: ' + xhr.responseText);
            }
        });
    });
});
</script>

<script>




document.addEventListener('DOMContentLoaded', function() {
    const mobileToggle = document.getElementById('mobileMenuToggle');
    const sidebar = document.getElementById('sidebarCustom');
    const body = document.body;

    if (mobileToggle && sidebar) {
        mobileToggle.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            // Toggle la classe pour afficher/masquer la sidebar en mode responsive
            sidebar.classList.toggle('sidebar-open');
            body.classList.toggle('sidebar-open'); // Optionnel : bloque le scroll du body quand ouvert
            
            // Rotate l'icône (optionnel, pour effet visuel)
            const icon = mobileToggle.querySelector('i');
            if (icon) {
                icon.classList.toggle('rotate-180');
            }
        });
    }

    // Fermer la sidebar si clic hors d'elle en mode responsive
    document.addEventListener('click', function(e) {
        const isMobile = window.innerWidth <= 1024;
        if (isMobile && sidebar && sidebar.classList.contains('sidebar-open') && 
            !sidebar.contains(e.target) && !mobileToggle.contains(e.target)) {
            sidebar.classList.remove('sidebar-open');
            body.classList.remove('sidebar-open');
            
            // Reset icône
            const icon = mobileToggle.querySelector('i');
            if (icon) {
                icon.classList.remove('rotate-180');
            }
        }
    });

    // Adapter au redimensionnement de fenêtre (intègre avec le JS précédent si existant)
    window.addEventListener('resize', function() {
        const isMobile = window.innerWidth <= 1024;
        if (isMobile) {
            // Forcer état mobile
            if (sidebar) sidebar.classList.remove('sidebar-expanded', 'sidebar-collapsed');
        } else {
            // Fermer si ouvert en mobile
            if (sidebar) {
                sidebar.classList.remove('sidebar-open');
                body.classList.remove('sidebar-open');
            }
        }
    });
});





</script>
</body>
</html>