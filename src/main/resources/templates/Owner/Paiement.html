<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org">
<head>
    <!-- Meta Tags -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Espace Propriétaire - Gestion des Paiements</title>

    <!-- External CSS and Fonts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.5.0/css/flag-icon.min.css" rel="stylesheet">
    <!-- Chart.js et Particles.js sont conservés car utilisés -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- FullCalendar supprimé car non utilisé ici -->
    <!-- Toastify CSS -->
    <link href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/assets/css/paimentowner.css}">
</head>
<body class="light-theme"> <!-- Forcer thème clair -->
    <div id="particles-js"></div>

    <!-- Barre de navigation (Style Tailwind) -->
  <nav class="navbar-custom-tailwind" th:fragment="navbar">
    <div class="navbar-left">
        <span class="brand">ABIcars</span>
    </div>
    <div class="navbar-right">
        <!-- Bouton menu hamburger pour responsive (visible seulement sur mobile) -->
        <div class="nav-icon-btn mobile-menu-toggle" id="mobileMenuToggle">
            <i class="fas fa-bars"></i>
        </div>
        
        <div class="nav-icon-btn" id="alertsIconCustom">
            <!-- Contenu des alertes si besoin -->
        </div>
        <div class="nav-icon-btn" id="languageSwitchCustom">
            <span class="flag-icon flag-icon-fr"></span>
        </div>
        <div class="user-profile" id="userProfileCustom"> <!-- Utilisation du style user-profile -->
            <i class="fas fa-user-circle"></i> <!-- Icône Font Awesome plus stylée -->
            <span th:text="${currentUser != null ? currentUser.firstName + ' ' + currentUser.lastName : 'Invité'}"></span>
            <i class="fas fa-chevron-down fa-xs"></i>
        </div>
        <div class="dropdown-menu-custom" id="userDropdownCustom">
            <a href="#" id="showUserProfile">
                <i class="fas fa-user-edit"></i>Mon profil
            </a>
          <a th:href="@{/Siteoffeciel/index}" >
  <i class="fas fa-sign-out-alt"></i>Se déconnecter
</a>
        </div>
    </div>
</nav>
<div class="modal fade" id="userModal" tabindex="-1" aria-labelledby="userModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      
      <div class="modal-header bg-primary text-white rounded-top">
        <h5 class="modal-title" id="userModalLabel">Profil Utilisateur</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body user-info">
        <form id="userProfileForm">
          <div class="row g-3">

            <div class="col-md-6">
              <label for="firstName" class="form-label">Prénom</label>
              <input type="text" class="form-control" id="firstName" name="firstName">
            </div>

            <div class="col-md-6">
              <label for="lastName" class="form-label">Nom</label>
              <input type="text" class="form-control" id="lastName" name="lastName">
            </div>

            <div class="col-md-6">
              <label for="phone" class="form-label">Téléphone</label>
              <input type="tel" class="form-control" id="phone" name="phone">
            </div>

            <div class="col-md-6">
              <label for="email" class="form-label">Email</label>
              <input type="email" class="form-control" id="email" name="email">
            </div>

            <div class="col-12 position-relative">
              <label for="password" class="form-label">Nouveau mot de passe</label>
              <input type="password" class="form-control pe-5" id="password" name="password">
                        <i class="fas fa-eye password-toggle" id="togglePassword"></i>
            </div>

          </div>
        </form>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
        <button type="button" class="btn btn-primary" id="saveProfile">Enregistrer</button>
      </div>

    </div>
  </div>
</div>
    <!-- Modal pour les alertes (Style non-Bootstrap personnalisé) -->
    <div class="modal-custom-non-bootstrap" id="alertsModalCustom">
        <div class="modal-header-custom-non-bootstrap">
            <h3>Alertes récentes</h3>
            <span class="close-btn" id="closeAlertsModalCustom">×</span>
        </div>
        <div class="modal-body-custom-non-bootstrap">
             <div class="alert-item">
                <div class="alert-content">
                    <div class="alert-title">Paiement Reçu</div>
                    <div class="alert-message">Paiement de 150€ de Jean Dupont.</div>
                </div>
                <div class="alert-meta">
                    <div class="alert-time">Il y a 5 min</div>
                    <span class="alert-status status-new">Nouveau</span>
                </div>
            </div>
            <div class="alert-item">
                <div class="alert-content">
                    <div class="alert-title">Paiement en Attente</div>
                    <div class="alert-message">Vérifier le paiement de Marie Martin.</div>
                </div>
                <div class="alert-meta">
                    <div class="alert-time">Il y a 1 heure</div>
                    <span class="alert-status status-waiting">En Attente</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Barre latérale (Style Tailwind) -->
    <aside id="sidebarCustom" class="sidebar-custom-tailwind sidebar-expanded">
        <div class="sidebar-header">
            <div class="brand-logo-wrapper">
                <i class="fas fa-car-alt brand-icon"></i>ABIcars</span>
            </div>
            <button id="toggleSidebarCustom" class="toggle-btn">
                <i class="fas fa-chevron-left"></i>
            </button>
        </div>
        <nav class="sidebar-menu">
            <a href="/Owner/dashbord" class="sidebar-item">
                <i class="fas fa-tachometer-alt menu-icon text-blue-400"></i>
                <span class="sidebar-text">Tableau de Bord</span>
            </a>
            <a href="/Owner/message" class="sidebar-item">
                <i class="fas fa-envelope menu-icon text-sky-400"></i>
                <span class="sidebar-text">Messages</span>
            </a>
            <a href="/Owner/clientespace" class="sidebar-item">
                <i class="fas fa-users menu-icon text-fuchsia-400"></i>
                <span class="sidebar-text">Clients</span>
            </a>
            <a href="/Owner/litige" class="sidebar-item">
                <i class="fas fa-gavel menu-icon text-rose-500"></i>
                <span class="sidebar-text">Litiges</span>
            </a>
            <a href="/Owner/voitures" class="sidebar-item">
                <i class="fas fa-car-side menu-icon text-emerald-500"></i>
                <span class="sidebar-text">Voitures</span>
            </a>
            <a href="/Owner/reservation" class="sidebar-item">
                <i class="fas fa-calendar-check menu-icon text-amber-500"></i>
                <span class="sidebar-text">Réservations</span>
            </a>
            <a href="/Owner/notifications" class="sidebar-item">
                <i class="fas fa-bell menu-icon text-violet-500"></i>
                <span class="sidebar-text">Notifications</span>
            </a>
              <a href="/Owner/entretiens" class="sidebar-item">
    <i class="fas fa-wrench menu-icon text-orange-400"></i>
    <span class="sidebar-text">Entretiens</span>
</a>
            <a href="/Owner/paiement" class="sidebar-item active"> <!-- Paiement est actif -->
                <i class="fas fa-credit-card menu-icon text-cyan-500"></i>
                <span class="sidebar-text">Paiement</span>
            </a>
        </nav>
    </aside>


    <!-- Main Content (Structure originale conservée) -->
    <div id="mainContent" class="main-content sidebar-expanded">
        <div class="container-paiement animate-fadeInUp">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="text-2xl font-bold">Espace Paiements</h1>
                 <!-- Bouton Thème supprimé -->
            </div>
            <div class="d-flex gap-2 mb-4">
                <button id="historyTab" class="tab active">Historique des Paiements</button>
                <button id="revenueTab" class="tab">Revenus par Voiture</button>
            </div>
            

            <section id="paymentHistory" class="section" style="display: block;">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h2 class="text-xl font-semibold">Historique des Paiements</h2>
                    <button id="downloadExcel" class="btn-export"><i class="fas fa-file-excel me-2"></i>Exporter Excel</button>
                </div>
                <div class="table-responsive">
                  <table class="table table-hover" id="paymentsTable">
    <thead>
        <tr>
            <th data-field="date" data-sortable="true">Date</th>
            <th data-field="montant" data-sortable="true">Montant</th>
            <th data-field="voiture" data-sortable="true">Voiture</th>
            <th data-field="client" data-sortable="true">Client</th>
            <th data-field="statut" data-sortable="true" class="text-center">Statut</th>
            <th class="text-center">Action</th>
        </tr>
    </thead>
    <tbody>
        <tr th:if="${paiements.empty}">
            <td colspan="7" class="text-center text-muted">
                <i class="fa fa-info-circle"></i> Aucun paiement trouvé
            </td>
        </tr>
        <tr th:each="paiement : ${paiements}" th:unless="${paiements.empty}">
            <!-- ✅ CORRIGÉ : Utilise paiement.date (déjà formatée en String) -->
            <td th:text="${paiement.date}"></td>
            
            <!-- ✅ CORRIGÉ : Format du montant -->
            <td th:text="${#numbers.formatDecimal(paiement.montant, 1, 'COMMA', 2, 'POINT')} + ' €'"></td>
            
            <!-- ✅ CORRIGÉ : Utilise paiement.voitureMarque (déjà formatée) -->
            <td th:text="${paiement.voitureMarque}"></td>
            
            <!-- ✅ CORRIGÉ : Utilise paiement.clientNom (déjà formaté) -->
            <td th:text="${paiement.clientNom}"></td>
            
            <!-- ✅ CORRIGÉ : Utilise paiement.statut (déjà en String) -->
            <td class="text-center">
              <span th:text="${paiement.statut}"
      th:classappend="${paiement.statut == 'PAYE' ? 'statut-paye' : (paiement.statut == 'EN_ATTENTE' ? 'statut-attente' : 'statut-annule')}"
      class="status-badge">
</span>

            </td>
            <td class="text-center">
                <!-- Bouton Voir détails -->
                <a href="#" class="voir-detail me-2" th:attr="data-id=${paiement.id}" title="Voir détails">
                    <i class="fa fa-eye text-primary"></i>
                </a>
                
                <!-- TEMPORAIRE : Sans vérification de facture -->
                <a th:if="${paiement.statut == 'PAYE'}"
                   th:href="@{/Owner/factures/generer/{id}(id=${paiement.id})}"
                   target="_blank"
                   title="Télécharger Facture">
                    <i class="fa fa-file-pdf text-warning"></i>
                </a>
                
                <a th:unless="${paiement.statut == 'PAYE'}"
                   href="#"
                   aria-disabled="true"
                   class="disabled text-secondary"
                   title="Facture disponible après paiement">
                    <i class="fa fa-file-pdf text-muted"></i>
                </a>
            </td>
        </tr>
    </tbody>
</table>
                </div>
            </section>

            <section id="revenueByCar" class="section" style="display: none;"> <!-- Caché par défaut -->
                <h2 class="text-2xl font-semibold mb-3">Revenus par Voiture</h2>
                <div class="chart-container mb-4">
                    <canvas id="revenueChart"></canvas>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Voiture</th>
                                <th class="text-end">Revenu Total (€)</th>
                                <th class="text-center">Nombre de Locations</th>
                            </tr>
                        </thead>
                        <tbody id="revenueTableBody"> <!-- Ajout d'un ID pour le JS -->
                             <tr th:each="rev : ${revenus}">
                                <td th:text="${rev.carBrand + ' ' + rev.carModel}"></td>
                                <td class="text-end" th:text="${#numbers.formatDecimal(rev.totalRevenue, 1, 'COMMA', 2, 'POINT')}"></td>
                                <td class="text-center" th:text="${rev.rentalCount}"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>
        </div>
    </div>

    <!-- Modal Paiement Détails -->
    <div class="modal fade" id="paiementModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Détails du paiement</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body" id="modal-body-content">
            Chargement...
          </div>
        </div>
      </div>
    </div>


    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script th:inline="javascript">
        // Gestion de la nouvelle sidebar/navbar (style Tailwind)
        const sidebarCustomEl = document.getElementById('sidebarCustom');
        const mainContentEl = document.getElementById('mainContent');
        const toggleSidebarCustomBtnEl = document.getElementById('toggleSidebarCustom');
        const mobileSidebarToggleBtnEl = document.getElementById('mobileSidebarToggle');
        const sidebarToggleIconEl = toggleSidebarCustomBtnEl ? toggleSidebarCustomBtnEl.querySelector('i') : null;


        function toggleActualSidebar() {
            if (!sidebarCustomEl || !mainContentEl || !sidebarToggleIconEl) return;

            const isExpanded = sidebarCustomEl.classList.contains('sidebar-expanded');
            if (window.innerWidth <= 768) {
                sidebarCustomEl.classList.toggle('sidebar-show');
            } else {
                if (isExpanded) {
                    sidebarCustomEl.classList.remove('sidebar-expanded');
                    sidebarCustomEl.classList.add('sidebar-collapsed');
                    mainContentEl.classList.remove('sidebar-expanded');
                    mainContentEl.classList.add('sidebar-collapsed');
                    sidebarToggleIconEl.classList.remove('fa-chevron-left');
                    sidebarToggleIconEl.classList.add('fa-chevron-right');
                } else {
                    sidebarCustomEl.classList.remove('sidebar-collapsed');
                    sidebarCustomEl.classList.add('sidebar-expanded');
                    mainContentEl.classList.remove('sidebar-collapsed');
                    mainContentEl.classList.add('sidebar-expanded');
                    sidebarToggleIconEl.classList.remove('fa-chevron-right');
                    sidebarToggleIconEl.classList.add('fa-chevron-left');
                }
            }
        }
        if(toggleSidebarCustomBtnEl) toggleSidebarCustomBtnEl.addEventListener('click', toggleActualSidebar);
        if(mobileSidebarToggleBtnEl) mobileSidebarToggleBtnEl.addEventListener('click', toggleActualSidebar);


        const userProfileCustomEl = document.getElementById('userProfileCustom');
        const userDropdownCustomEl = document.getElementById('userDropdownCustom');
        if(userProfileCustomEl && userDropdownCustomEl){
            userProfileCustomEl.addEventListener('click', (event) => {
                event.stopPropagation();
                const isActive = userDropdownCustomEl.classList.toggle('active');
                userProfileCustomEl.classList.toggle('dropdown-active', isActive);
            });
        }

        const alertsIconCustomEl = document.getElementById('alertsIconCustom');
        const alertsModalCustomEl = document.getElementById('alertsModalCustom');
        const closeAlertsModalCustomBtnEl = document.getElementById('closeAlertsModalCustom');
        if(alertsIconCustomEl && alertsModalCustomEl && closeAlertsModalCustomBtnEl){
            alertsIconCustomEl.addEventListener('click', (event) => {
                event.stopPropagation();
                alertsModalCustomEl.classList.toggle('active');
                if(userDropdownCustomEl) userDropdownCustomEl.classList.remove('active');
                if(userProfileCustomEl) userProfileCustomEl.classList.remove('dropdown-active');
            });
            closeAlertsModalCustomBtnEl.addEventListener('click', () => {
                alertsModalCustomEl.classList.remove('active');
            });
        }

        document.addEventListener('click', (event) => {
            if (userProfileCustomEl && !userProfileCustomEl.contains(event.target) && userDropdownCustomEl && !userDropdownCustomEl.contains(event.target)) {
                if(userDropdownCustomEl) userDropdownCustomEl.classList.remove('active');
                 if(userProfileCustomEl) userProfileCustomEl.classList.remove('dropdown-active');
            }
            if (alertsIconCustomEl && !alertsIconCustomEl.contains(event.target) && alertsModalCustomEl && !alertsModalCustomEl.contains(event.target)) {
                if(alertsModalCustomEl) alertsModalCustomEl.classList.remove('active');
            }
            if (window.innerWidth <= 768 && sidebarCustomEl && !sidebarCustomEl.contains(event.target) && mobileSidebarToggleBtnEl && !mobileSidebarToggleBtnEl.contains(event.target)) {
                 if(sidebarCustomEl) sidebarCustomEl.classList.remove('sidebar-show');
            }
        });

        const languageSwitchCustomEl = document.getElementById('languageSwitchCustom');
        if (languageSwitchCustomEl) {
            const flagIconCustomEl = languageSwitchCustomEl.querySelector('.flag-icon');
            let currentLangCustomVal = 'fr';
            languageSwitchCustomEl.addEventListener('click', () => {
                if (currentLangCustomVal === 'fr') {
                    if(flagIconCustomEl) {flagIconCustomEl.classList.remove('flag-icon-fr'); flagIconCustomEl.classList.add('flag-icon-gb');}
                    currentLangCustomVal = 'gb';
                } else {
                     if(flagIconCustomEl) {flagIconCustomEl.classList.remove('flag-icon-gb'); flagIconCustomEl.classList.add('flag-icon-fr');}
                    currentLangCustomVal = 'fr';
                }
            });
        }
        document.body.className = 'light-theme';


        // Logique spécifique à la page Gestion des Paiements (conservée)
        $(document).ready(function() {
            particlesJS('particles-js', { /* ... configuration particles.js ... */ });

            // Initialisation des données (simulée ici, sera remplacée par Thymeleaf)
            const paiementsData = /*[[${paiements}]]*/ [];
            const revenusData = /*[[${revenus}]]*/ [];


            function populatePaymentTable() {
                const paymentTableBody = $('#paymentsTable tbody'); // Cibler tbody
                paymentTableBody.empty();
                paiementsData.forEach(payment => {
                     const formattedDate = payment.date ? new Date(payment.date).toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric', hour:'2-digit', minute:'2-digit'}) : 'N/A';
                    const statusClass = payment.statut === 'PAYE' ? 'statut-paye' :
                                      payment.statut === 'EN_ATTENTE' ? 'statut-attente' :
                                      'statut-annule';
                    const row = `
                        <tr>
                            <td class="px-4 py-2">${formattedDate}</td>
                            <td class="px-4 py-2">${payment.montant.toFixed(2)} €</td>
                            <td class="px-4 py-2">${payment.reservation.voiture.marque} ${payment.reservation.voiture.modele}</td>
                            <td class="px-4 py-2">${payment.reservation.utilisateur.firstName} ${payment.reservation.utilisateur.lastName}</td>
                            <td class="px-4 py-2 text-center font-semibold">
                                <span class="status-badge ${statusClass}">${payment.statut}</span>
                            </td>
                            <td class="text-center">
                                <a href="#" class="voir-detail me-2" data-id="${payment.id}" title="Voir détails">
                                    <i class="fa fa-eye text-primary"></i>
                                </a>
                                ${payment.factureFilename ? `<a href="/fichiers/factures/${payment.factureFilename}" target="_blank" title="Télécharger Facture">
                                    <i class="fa fa-file-pdf text-danger"></i>
                                </a>` : ''}
                            </td>
                        </tr>`;
                    paymentTableBody.append(row);
                });
            }

            function populateRevenueTable() {
                const revenueTableBody = $('#revenueByCar tbody'); // Cibler tbody
                revenueTableBody.empty();
                revenusData.forEach(revenue => {
                    const row = `
                        <tr>
                            <td class="px-4 py-2">${revenue.carBrand} ${revenue.carModel}</td>
                            <td class="px-4 py-2 text-end">${revenue.totalRevenue.toFixed(2)}</td>
                            <td class="px-4 py-2 text-center">${revenue.rentalCount}</td>
                        </tr>`;
                    revenueTableBody.append(row);
                });
            }

            let revenueChartInstance;
            function renderRevenueChart() {
                const ctx = document.getElementById('revenueChart');
                if (!ctx) return;
                if (revenueChartInstance) revenueChartInstance.destroy();
                revenueChartInstance = new Chart(ctx.getContext('2d'), {
                    type: 'pie',
                    data: {
                        labels: revenusData.map(r => `${r.carBrand} ${r.carModel}`),
                        datasets: [{
                            label: 'Revenu Total (€)', data: revenusData.map(r => r.totalRevenue),
                            backgroundColor: ['#3B82F6', '#60A5FA', '#93C5FD', '#BFDBFE', '#DBEAFE'],
                            borderColor: '#ffffff', borderWidth: 2
                        }]
                    },
                    options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
                });
            }

            function switchTab(showSectionId, hideSectionId, activeTabEl, inactiveTabEl) {
                $(hideSectionId).hide(); // Utiliser hide() de jQuery
                $(showSectionId).show(); // Utiliser show() de jQuery
                $(activeTabEl).addClass('active');
                $(inactiveTabEl).removeClass('active');
                if (showSectionId === '#paymentHistory') {
                    populatePaymentTable();
                } else if (showSectionId === '#revenueByCar') {
                    populateRevenueTable();
                    renderRevenueChart();
                }
            }

            $('#revenueTab').click(() => switchTab('#revenueByCar', '#paymentHistory', '#revenueTab', '#historyTab'));

            $('#downloadExcel').click(function () {
                const table = document.getElementById("paymentsTable");
                if (!table) { alert("Tableau introuvable !"); return; }
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.table_to_sheet(table);
                XLSX.utils.book_append_sheet(wb, ws, "HistoriquePaiements");
                XLSX.writeFile(wb, "historique_paiements.xlsx");
            });

            $(document).on("click", ".voir-detail", function(e) {
                e.preventDefault();
                const paiementId = $(this).data("id");
                const paiementDetail = paiementsData.find(p => p.id == paiementId);
                
                console.log('=== DEBUG PAIEMENT DETAIL ===');
                console.log('Paiement complet:', paiementDetail);
                console.log('============================');

                if (paiementDetail) {
                    // Utilisez les données disponibles (maintenant reservation devrait être rempli)
                    const reservation = paiementDetail.reservation || {};
                    const client = paiementDetail.client || {};
                    const voiture = paiementDetail.voiture || {};

                    // Dates
                    const datePaiement = paiementDetail.date 
                        ? new Date(paiementDetail.date).toLocaleDateString('fr-FR') 
                        : "N/A";

                    // Montants
                    const montant = (typeof paiementDetail.montant === "number") 
                        ? paiementDetail.montant.toFixed(2) 
                        : "N/A";

                    // Informations client (priorité aux champs directs)
                    let nomClientComplet = paiementDetail.clientNom || "Client inconnu";
                    if (!paiementDetail.clientNom && client.nom) {
                        nomClientComplet = client.prenom ? `${client.prenom} ${client.nom}` : client.nom;
                    }

                    // Informations voiture (priorité aux champs directs)
                    let voitureInfo = paiementDetail.voitureMarque || "Inconnue";
                    if (!paiementDetail.voitureMarque && voiture.marque) {
                        voitureInfo = voiture.modele ? `${voiture.marque} ${voiture.modele}` : voiture.marque;
                    }

                    const statutPaiement = paiementDetail.statut || "Inconnu";
                    const methodePaiement = paiementDetail.methode || "N/A";

                    // Informations réservation
                    const dateDebut = reservation.dateDebut 
                        ? new Date(reservation.dateDebut).toLocaleDateString('fr-FR') 
                        : "N/A";

                    const dateFin = reservation.dateFin 
                        ? new Date(reservation.dateFin).toLocaleDateString('fr-FR') 
                        : "N/A";

                    const statutReservation = reservation.statutReservation || reservation.statut || "Inconnu";
                    const prixTotal = reservation.prixTotal || reservation.prix || reservation.amount || "N/A";
                    const prixTotalFormatted = (typeof prixTotal === "number") ? prixTotal.toFixed(2) + " €" : prixTotal;

                    const adressePriseEnCharge = reservation.adressePriseEnCharge || "N/A";
                    const adresseRestitution = reservation.adresseRestitution || "N/A";

                    // Vérifier si on a des données de réservation complètes
                    const hasReservationDetails = reservation.dateDebut || reservation.dateFin || 
                                                reservation.adressePriseEnCharge || reservation.adresseRestitution;

                    $('#modal-body-content').html(`
                        <div class="space-y-4">
                            <!-- Informations paiement -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <p class="text-sm text-gray-600">Date paiement</p>
                                    <p class="font-medium text-gray-900">${datePaiement}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-600">Montant payé</p>
                                    <p class="font-medium text-gray-900">${montant} €</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-600">Méthode de paiement</p>
                                    <p class="font-medium text-gray-900">${methodePaiement}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-600">Statut paiement</p>
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
                                        statutPaiement === 'PAYE' ? 'bg-green-100 text-green-800' : 
                                        statutPaiement === 'REMBOURSE' ? 'bg-blue-100 text-blue-800' : 
                                        'bg-yellow-100 text-yellow-800'
                                    }">
                                        ${statutPaiement}
                                    </span>
                                </div>
                            </div>

                            <!-- Informations client et voiture -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                               
                                <div>
                                    <p class="text-sm text-gray-600">Voiture</p>
                                    <p class="font-medium text-gray-900">${voitureInfo}</p>
                                </div>
                            </div>

                            ${hasReservationDetails ? `
                                <hr class="my-2">
                                
                                <!-- Informations réservation -->
                                <div>
                                    <h6 class="font-semibold text-gray-700 mb-3">Détails de la réservation</h6>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <p class="text-sm text-gray-600">Statut réservation</p>
                                            <p class="font-medium text-gray-900">${statutReservation}</p>
                                        </div>
                                        <div>
                                            <p class="text-sm text-gray-600">Prix total</p>
                                            <p class="font-medium text-gray-900">${prixTotalFormatted}</p>
                                        </div>
                                        <div>
                                            <p class="text-sm text-gray-600">Date de début</p>
                                            <p class="font-medium text-gray-900">${dateDebut}</p>
                                        </div>
                                        <div>
                                            <p class="text-sm text-gray-600">Date de fin</p>
                                            <p class="font-medium text-gray-900">${dateFin}</p>
                                        </div>
                                        <div>
                                            <p class="text-sm text-gray-600">Lieu de prise en charge</p>
                                            <p class="font-medium text-gray-900">${adressePriseEnCharge}</p>
                                        </div>
                                        <div>
                                            <p class="text-sm text-gray-600">Lieu de restitution</p>
                                            <p class="font-medium text-gray-900">${adresseRestitution}</p>
                                        </div>
                                    </div>
                                </div>
                            ` : `
                                <hr class="my-2">
                                <div class="bg-yellow-50 border border-yellow-200 rounded-md p-3">
                                    <p class="text-yellow-800 text-sm font-medium mb-1">Information limitée</p>
                                    <p class="text-yellow-700 text-xs">Les détails complets de la réservation ne sont pas disponibles.</p>
                                </div>
                            `}

                            ${paiementDetail.factureFilename ? `
                                <div class="pt-2 border-t">
                                    <a href="/fichiers/factures/${paiementDetail.factureFilename}" 
                                       target="_blank" 
                                       rel="noopener noreferrer" 
                                       class="inline-flex items-center text-blue-600 hover:text-blue-800 font-medium">
                                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                        </svg>
                                        Télécharger la facture
                                    </a>
                                </div>
                            ` : ''}
                        </div>
                    `);
                    
                    new bootstrap.Modal(document.getElementById('paiementModal')).show();
                } else {
                    $('#modal-body-content').html(`
                        <div class="text-center py-4">
                            <p class="text-red-600 font-medium">Détails non trouvés</p>
                            <p class="text-gray-500 text-sm mt-1">Impossible de charger les informations du paiement</p>
                        </div>
                    `);
                    new bootstrap.Modal(document.getElementById('paiementModal')).show();
                }
            });
        });

    </script>
    <script>
  function switchTab(showSectionId, hideSectionId, activateTabId, deactivateTabId) {
    $(hideSectionId).hide();
    $(showSectionId).show();

    $(deactivateTabId).removeClass("active");
    $(activateTabId).addClass("active");
  }

  $('#historyTab').click(() => switchTab('#paymentHistory', '#revenueByCar', '#historyTab', '#revenueTab'));
  $('#revenueTab').click(() => switchTab('#revenueByCar', '#paymentHistory', '#revenueTab', '#historyTab'));
</script>
<script>
$(document).ready(function() {
    // Charger les données de l'utilisateur
    $('#showUserProfile').click(function(e) {
        e.preventDefault();
        $.ajax({
            url: '/api/user/profille',
            type: 'GET',
            success: function(user) {
                $('#firstName').val(user.firstName);
                $('#lastName').val(user.lastName);
                $('#phone').val(user.telephone);
                $('#email').val(user.email);
                $('#password').val(''); // Champ mot de passe vide par défaut
            },
            error: function(xhr) {
                alert('Erreur lors de la récupération des informations: ' + xhr.responseText);
            }
        });
    });

    // Basculer l'affichage du mot de passe
    $('#togglePassword').click(function() {
        const passwordField = $('#password');
        const type = passwordField.attr('type') === 'password' ? 'text' : 'password';
        passwordField.attr('type', type);
        $(this).toggleClass('fa-eye fa-eye-slash');
    });

    // Enregistrer les modifications
    $('#saveProfile').click(function() {
        const userData = {
            firstName: $('#firstName').val(),
            lastName: $('#lastName').val(),
            telephone: $('#phone').val(),
            email: $('#email').val(),
            password: $('#password').val()
        };

        $.ajax({
            url: '/api/user/proprofile',
            type: 'PUT',
            contentType: 'application/json',
            data: JSON.stringify(userData),
            success: function(response) {
                alert('Profil mis à jour avec succès !');
                $('#userModal').modal('hide');
            },
            error: function(xhr) {
                alert('Erreur lors de la mise à jour du profil: ' + xhr.responseText);
            }
        });
    });
});
</script>
<script>




document.addEventListener('DOMContentLoaded', function() {
    const mobileToggle = document.getElementById('mobileMenuToggle');
    const sidebar = document.getElementById('sidebarCustom');
    const body = document.body;

    if (mobileToggle && sidebar) {
        mobileToggle.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            // Toggle la classe pour afficher/masquer la sidebar en mode responsive
            sidebar.classList.toggle('sidebar-open');
            body.classList.toggle('sidebar-open'); // Optionnel : bloque le scroll du body quand ouvert
            
            // Rotate l'icône (optionnel, pour effet visuel)
            const icon = mobileToggle.querySelector('i');
            if (icon) {
                icon.classList.toggle('rotate-180');
            }
        });
    }

    // Fermer la sidebar si clic hors d'elle en mode responsive
    document.addEventListener('click', function(e) {
        const isMobile = window.innerWidth <= 1024;
        if (isMobile && sidebar && sidebar.classList.contains('sidebar-open') && 
            !sidebar.contains(e.target) && !mobileToggle.contains(e.target)) {
            sidebar.classList.remove('sidebar-open');
            body.classList.remove('sidebar-open');
            
            // Reset icône
            const icon = mobileToggle.querySelector('i');
            if (icon) {
                icon.classList.remove('rotate-180');
            }
        }
    });

    // Adapter au redimensionnement de fenêtre (intègre avec le JS précédent si existant)
    window.addEventListener('resize', function() {
        const isMobile = window.innerWidth <= 1024;
        if (isMobile) {
            // Forcer état mobile
            if (sidebar) sidebar.classList.remove('sidebar-expanded', 'sidebar-collapsed');
        } else {
            // Fermer si ouvert en mobile
            if (sidebar) {
                sidebar.classList.remove('sidebar-open');
                body.classList.remove('sidebar-open');
            }
        }
    });
});





</script>
</body>
</html>